---
title: "F1 Data Transformations"
author: "Derek Rogers"
date: "2023-01-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#circuitsDataFrame = data.frame(read.csv("C:/Santi/paths/go/here"))

#circuitsDataFrame = data.frame(read.csv("C:/Shawn/paths/go/here"))

circuitsDataFrame = read.csv("C:/SMU MS Data Science/AppliedStatistics6372/Project1/F1ParametricModeling/Data/circuits.csv")
constructorResultsDataFrame = read.csv("C:/SMU MS Data Science/AppliedStatistics6372/Project1/F1ParametricModeling/Data/constructor_results.csv")
constructorStandingsDataFrame = read.csv("C:/SMU MS Data Science/AppliedStatistics6372/Project1/F1ParametricModeling/Data/constructor_standings.csv")
constructorsDataFrame = read.csv("C:/SMU MS Data Science/AppliedStatistics6372/Project1/F1ParametricModeling/Data/constructors.csv")
driverStandingsDataFrame = read.csv("C:/SMU MS Data Science/AppliedStatistics6372/Project1/F1ParametricModeling/Data/driver_standings.csv")
driversDataFrame = read.csv("C:/SMU MS Data Science/AppliedStatistics6372/Project1/F1ParametricModeling/Data/drivers.csv")
lapTimesDataFrame = read.csv("C:/SMU MS Data Science/AppliedStatistics6372/Project1/F1ParametricModeling/Data/lap_times.csv")
pitStopsDataFrame = read.csv("C:/SMU MS Data Science/AppliedStatistics6372/Project1/F1ParametricModeling/Data/pit_stops.csv")
qualifyingDataFrame = read.csv("C:/SMU MS Data Science/AppliedStatistics6372/Project1/F1ParametricModeling/Data/qualifying.csv")
racesDataFrame = read.csv("C:/SMU MS Data Science/AppliedStatistics6372/Project1/F1ParametricModeling/Data/races.csv")
resultsDataFrame = read.csv("C:/SMU MS Data Science/AppliedStatistics6372/Project1/F1ParametricModeling/Data/results.csv")
seasonsDataFrame = read.csv("C:/SMU MS Data Science/AppliedStatistics6372/Project1/F1ParametricModeling/Data/seasons.csv")
sprint_resultsDataFrame = read.csv("C:/SMU MS Data Science/AppliedStatistics6372/Project1/F1ParametricModeling/Data/sprint_results.csv")
statusDataFrame = read.csv("C:/SMU MS Data Science/AppliedStatistics6372/Project1/F1ParametricModeling/Data/status.csv")

# Fill in the 2 missing altitudes
circuitsDataFrame[circuitsDataFrame$name == "Losail International Circuit",]$alt = 14
circuitsDataFrame[circuitsDataFrame$name == "Miami International Autodrome",]$alt = 1

# Convert altitude from character to numeric
circuitsDataFrame$alt = as.numeric(circuitsDataFrame$alt)
```

```{r}
head(circuitsDataFrame)
head(constructorResultsDataFrame)
head(constructorStandingsDataFrame)
head(constructorsDataFrame)
head(driverStandingsDataFrame)
head(driversDataFrame)
head(lapTimesDataFrame)
head(pitStopsDataFrame)
head(qualifyingDataFrame)
head(racesDataFrame)
head(resultsDataFrame)
head(seasonsDataFrame)
head(sprint_resultsDataFrame)
head(statusDataFrame)
```

```{r}
# Merge of the circuits and races dataframes
eventDataframe = merge(x = circuitsDataFrame, y = racesDataFrame, by = "circuitId")

#Merge of the constructor dataframes
constructorResultsFullDataFrame = merge(x = constructorResultsDataFrame, y = constructorsDataFrame, by = "constructorId")
constructorStandingsFullDataFrame = merge(x = constructorStandingsDataFrame, y = constructorsDataFrame, by = "constructorId")

#Merge of driver dataFrames
finalDriverStandingsDataframe = merge(x = driversDataFrame, y = driverStandingsDataFrame, by = "driverId")

head(eventDataframe)
head(constructorResultsFullDataFrame)
head(constructorStandingsFullDataFrame)
head(finalDriverStandingsDataframe)
```

Keep relevant columns for creating a dataframe that holds relevant information for modeling
```{r}
racesDataFrame = subset(racesDataFrame, select = c("raceId", "year", "circuitId", "name"))

resultsDataFrame = subset(resultsDataFrame, select = c("resultId", "raceId", "driverId", "constructorId", "grid", "positionOrder"))

circuitsDataFrame = subset(circuitsDataFrame, select = c("circuitId", "name", "alt"))

constructorsDataFrame = subset(constructorsDataFrame, select = c("constructorId", "name"))

driversDataFrame = subset(driversDataFrame, select = c("driverId", "forename", "surname"))
```

Merge relevant data into raceResultsDataframe
```{r}
raceResultsDataFrame = merge(x = racesDataFrame, y = resultsDataFrame, by = "raceId")

raceResultsDataFrame = merge(x = raceResultsDataFrame, y = circuitsDataFrame, by = "circuitId")

raceResultsDataFrame = merge(x = raceResultsDataFrame, y = constructorsDataFrame, by = "constructorId")

raceResultsDataFrame = merge(x = raceResultsDataFrame, y = driversDataFrame, by = "driverId")

raceResultsDataFrame$fullname = paste(raceResultsDataFrame$forename, raceResultsDataFrame$surname, sep = " ")
```

# Show the number of times constructors appear in the raceResultsDataframe and keep the 25 most popular constructors
```{r}
uniqueConstructorResults = raceResultsDataFrame %>% group_by(name) %>% tally()

uniqueConstructorResults$n = as.numeric(uniqueConstructorResults$n)

uniqueConstructorResults = uniqueConstructorResults[order(-uniqueConstructorResults$n),]

uniqueConstructorResults = head(uniqueConstructorResults[order(-uniqueConstructorResults$n),], 25)

uniqueConstructorResults = merge(x = uniqueConstructorResults, y = constructorsDataFrame, by = "name")

uniqueConstructorResults = uniqueConstructorResults[order(-uniqueConstructorResults$n),]

uniqueConstructorResults
```

# Show the number of times drivers appear in the raceResultsDataframe and keep the 25 drives with the highest number of races
```{r}
uniqueDriverResults = raceResultsDataFrame %>% group_by(driverId) %>% tally()

uniqueDriverResults$n = as.numeric(uniqueDriverResults$n)

uniqueDriverResults = uniqueDriverResults[order(-uniqueDriverResults$n),]

uniqueDriverResults = head(uniqueDriverResults, 25)

uniqueDriverResults = merge(x = uniqueDriverResults, y = driversDataFrame, by = "driverId")
  
uniqueDriverResults$fullname = paste(uniqueDriverResults$forename, uniqueDriverResults$surname, sep = " ")

uniqueDriverResults
```

Set top 20 drivers and constructors as categorical variables and the rest as "other"
```{r}
# For every race result check if the driver id matches a driver id from uniqueDriverResults
# If there isn't a match set the drivers full name to "Other"
for(i in 1:nrow(raceResultsDataFrame)){
  isUnique = FALSE
  for(j in 1:nrow(uniqueDriverResults)){
    if(raceResultsDataFrame[i,]$driverId == uniqueDriverResults[j,]$driverId){
      isUnique = TRUE
    }
  }
  if(!isUnique){
      raceResultsDataFrame[i,]$fullname = "Other"
  }
}

raceResultsDataFrame$fullname = as.factor(raceResultsDataFrame$fullname)
raceResultsDataFrame$fullname = droplevels(raceResultsDataFrame$fullname)
raceResultsDataFrame
```

Set top 20 drivers and constructors as categorical variables and the rest as "other"
```{r}
# For every race result check if the driver id matches a driver id from uniqueDriverResults
# If there isn't a match set the drivers full name to "Other"
for(i in 1:nrow(raceResultsDataFrame)){
  isUnique = FALSE
  for(j in 1:nrow(uniqueConstructorResults)){
    if(raceResultsDataFrame[i,]$constructorId == uniqueConstructorResults[j,]$constructorId){
      isUnique = TRUE
    }
  }
  if(!isUnique){
      raceResultsDataFrame[i,]$name = "Other"
  }
}

raceResultsDataFrame$name = as.factor(raceResultsDataFrame$name)
raceResultsDataFrame$name = droplevels(raceResultsDataFrame$name)
raceResultsDataFrame
```
```{r}
unique(raceResultsDataFrame$name)
unique(raceResultsDataFrame$fullname)
```

```{r}
model = lm(positionOrder ~ fullname + grid + alt + name + year + year:name + year:fullname + alt:name, data = raceResultsDataFrame)

summary(model)
```

